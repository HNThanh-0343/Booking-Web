@using WEBSITE_TRAVELBOOKING.Helper
@using WEBSITE_TRAVELBOOKING.Models
@model WEBSITE_TRAVELBOOKING.Models.SysHotel

@{
    var hotelAmenities = ViewBag.HotelAmenities as List<WEBSITE_TRAVELBOOKING.Models.CatAminitieseRoom> ?? new List<WEBSITE_TRAVELBOOKING.Models.CatAminitieseRoom>();
}

<style>
    /* Room details container */
    .room-details-container {
    display: flex;
    flex-direction: column;
    height: 70vh; /* Changed from 500px to 70% of viewport height */
    }

    .room-details-header {
    background-color: #fff;
    z-index: 10;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }

    .room-details-scroll {
    flex: 1;
    overflow-y: auto;
    max-height: 50vh; /* Changed from 300px to 50% of viewport height */
    padding-right: 10px;
    scrollbar-width: thin;
    }

    .room-details-scroll::-webkit-scrollbar {
    width: 5px;
    }

    .room-details-scroll::-webkit-scrollbar-thumb {
    background-color: rgba(0, 0, 0, 0.2);
    border-radius: 10px;
    }

    .room-details-scroll::-webkit-scrollbar-track {
    background-color: rgba(0, 0, 0, 0.05);
    }

    /* Modal size and position */
    #roomDetailModal .modal-dialog {
    max-width: 90vw;
    overflow: visible;
    }

    #roomDetailModal .modal-content {
    border-radius: 0;
    border: none;
    overflow: visible;
    }

    #roomDetailModal .modal-header {
    padding: 0;
    border-bottom: none;
    position: absolute;
    top: 0;
    right: 0;
    z-index: 1050;
    background: transparent;
    }

    #roomDetailModal .modal-content .close {
    position: absolute;
    top: 0;
    right: 0;
    transform: translate(50%, -50%);
    z-index: 1051;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 2.5rem;
    height: 2.5rem;
    opacity: 1 !important;
    background-color: #297cbb;
    border: none;
    border-radius: 50%;
    font-size: 1.25rem;
    line-height: 1;
    color: #fff;
    box-shadow: 0 2px 4px #000;
    transition: background-color .2s;
    }

    #roomDetailModal .modal-content .close:hover,
    #roomDetailModal .modal-content .close:focus {
    background-color: #1f5d8a;
    color: #fff;
    outline: none;
    }

    /* Responsive behavior */
    @@media (max-width: 767px) {
    .modal-carousel,
    .modal-carousel .js-slide img,
    .main-image-container,
    .main-image-container img {
    height: 40vh; /* Changed from 300px to 40% of viewport height */
    }

    .room-details-container {
    height: auto;
    max-height: 40vh; /* Changed from 300px to 40% of viewport height */
    }

    .room-details-scroll {
    max-height: 30vh; /* Changed from 220px to 30% of viewport height */
    }
    }

    /* Room modal amenities styles */
    #roomModalAmenities .row {
    margin: 0 -10px;
    }

    #roomModalAmenities .col-md-6 {
    padding: 0 10px;
    }

    #roomModalAmenities .d-flex {
    padding: 8px 0;
    }

    #roomModalAmenities,
    #hotelsAmenities i {
    font-size: 20px;
    min-width: 24px;
    }

    #roomModalAmenities span {
    font-size: 14px;
    }

    .amenities-preview .card-color__icon,
    .amenities-full .card-color__icon,
    #roomModalAmenities .card-color__icon {
    color: #939bad !important;
    transition: color 0.2s;
    }

    .amenities-preview .card-color__icon:hover,
    .amenities-full .card-color__icon:hover,
    #roomModalAmenities .card-color__icon:hover {
    color: #006ce4 !important;
    }

    /* Modal carousel */
    .modal-carousel {
    height: 70vh; /* Changed from 500px to 70% of viewport height */
    width: 100%;
    position: relative;
    overflow: hidden;
    }

    .modal-carousel .js-slide img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    object-position: center;
    }
</style>

<!-- Modal Chi tiết phòng -->
<div class="modal fade" id="roomDetailModal" tabindex="-1" role="dialog" aria-labelledby="roomDetailModalContent" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
        <div class="modal-content">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            <div class="modal-body p-0">
                <div class="card border-0 rounded-0 mb-0">
                    <div class="row no-gutters">
                        <!-- Image carousel - stretched to fit modal -->
                        <div class="col-md-8">
                            <div id="roomModalCarousel" class="js-slick-carousel u-slick modal-carousel overflow-hidden h-100" data-slides-show="1" data-slides-scroll="1" data-pagi-classes="text-right justify-content-end position-absolute right-0 bottom-0 left-0 u-slick__pagination u-slick__pagination--white mb-3 mr-3" data-arrows-classes="u-slick__arrow-classic u-slick__arrow-centered--y" data-arrow-left-classes="fas fa-arrow-left font-size-18 bg-transparent text-white u-slick__arrow-classic-inner u-slick__arrow-classic-inner--left ml-2" data-arrow-right-classes="fas fa-arrow-right font-size-18 bg-transparent text-white u-slick__arrow-classic-inner u-slick__arrow-classic-inner--right mr-2">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="room-details-container">
                                <!-- Fixed header section -->
                                <div class="room-details-header">
                                    <div class="d-flex justify-content-between align-items-center px-3 pt-3">
                                        <div id="roomModalName" class="font-weight-bold font-size-19 mb-0 mr-3 flex-grow-1">Room Name</div>
                                        <div class="d-flex flex-shrink-0">
                                            <a href="tele:@Model.Phone;" target="_blank" onclick="ghiloglienhe(1)" class="btn btn-primary btn-sm d-flex align-items-center justify-content-center mr-1" style="width: 44px; height: 44px;"><i class="fas fa-phone"></i></a>                                                
                                            <a href="https://zalo.me/@(ViewBag.hotelPhone)" onclick="ghiloglienhe(2)" class="btn btn-sm d-flex align-items-center justify-content-center p-0" style="height:44px;" target="_blank" type="submit" id="zalo">
                                                <img src='@Url.Content("~/assets/img/icons/zalo_icon.png")' style="height:44px; object-fit:contain;" alt="Zalo" />
                                            </a>
                                        </div>
                                    </div>
                                    <div class="mb-2 price-info px-3">
                                        <span class="mr-1 font-size-14 text-gray-1">Giá từ</span>
                                        <span id="roomModalPrice" class="font-weight-bold font-size-22 text-primary">0 VNĐ</span>
                                        <span class="font-size-14 text-gray-1"> / Đêm</span>
                                    </div>
                                    <div class="mb-3 room-type-info px-3">
                                        <div class="d-flex align-items-center card-color__icon" id="RoomTypeIcon">
                                            <i id="roomTypeIcon" class="mdi text-primary mr-2" style="font-size: 30px;"></i>
                                            <span id="roomTypeName" class="font-size-14 text-gray-3">Loại phòng</span>
                                        </div>
                                    </div>
                                </div>
                                <div class=" px-3 pt-3 mt-2">
                                    <div class="fw-bold mb-1"><b>Tiện nghi:</b></div>
                                </div>
                                <!-- Scrollable content section -->
                                <div class="room-details-scroll">
                                    <div id="roomModalAmenities" class="px-3">
                                        <!-- Amenities will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Lưu dữ liệu phòng để sử dụng khi cần
    var roomsData = [
    @foreach (var room in ViewBag.RoomsList)
    {
        var typeRoomName = room.TypeRoomNavigation != null ? room.TypeRoomNavigation.Name : "Phòng tiêu chuẩn";
        var typeRoomIcon = room.TypeRoomNavigation != null ? room.TypeRoomNavigation.Icon : "mdi-bed-outline";

        string listImgRaw = room.ListImg as string ?? string.Empty;

        var imgList = listImgRaw
            .Split(',', StringSplitOptions.RemoveEmptyEntries)   // skip empty pieces
            .Select(i => i.Trim())                               // trim spaces
            .Where(i => !string.IsNullOrWhiteSpace(i))           // extra safety
            .Select(i => Common.GetImagePath(i))                 // map to public URL
            .Where(p => !string.IsNullOrEmpty(p))
            .ToList();

        if (!imgList.Any())
            imgList.Add("/AppData/BaiViet/BaiVietMacDinh.jpg");

        var imgListJson = Json.Serialize(imgList);

        @:{  
        @:  id: @room.Id,
        @:  name: "@Html.Raw(room.Name.Replace("\"", "\\\""))",
        @:  price: "@room.Price.ToString("N0")",
        @:  typeRoomId: @(room.TypeRoom != null ? room.TypeRoom : 0),
        @:  typeRoomName: @Html.Raw(Json.Serialize(typeRoomName)),
        @:  typeRoomIcon: @Html.Raw(Json.Serialize(typeRoomIcon)),
        @:  amenitiesList: @Html.Raw(Json.Serialize(room.ListAminities)),
        @:  listImg: @Html.Raw(imgListJson)
        @:},
    }
    ];

    // Thiết lập modal chi tiết phòng
    function setupRoomDetailsModal() {
        console.log("Đã khởi tạo modal phòng, số lượng phòng:", roomsData?.length || 0);
    }

    // Hiển thị modal chi tiết phòng
    function showRoomModal(roomId) {
        try {
            // Tìm dữ liệu phòng theo ID
            const room = roomsData.find(r => r.id === roomId);
            if (!room) {
                console.error("Room not found with ID:", roomId);
                return;
            }

            const $modal = $('#roomDetailModal');
            const $carousel = $('#roomModalCarousel');

            // Hủy khởi tạo carousel hiện tại nếu đã được khởi tạo
            if ($carousel.hasClass('slick-initialized')) {
                $carousel.slick('unslick');
            }

            $('#roomModalName').text(room.name);
            $('#roomModalPrice').text(room.price + ' VNĐ');
            $('#roomTypeIcon').attr('class', room.typeRoomIcon + ' font-size-18 mr-2');
            $('#roomTypeName').text(room.typeRoomName);

            // Hiển thị hình ảnh trong carousel
            const carousel = document.getElementById('roomModalCarousel');

            const images = Array.isArray(room.listImg) && room.listImg.length
              ? room.listImg
              : ['/images/no-image.jpg'];

            carousel.innerHTML = images
              .map(img => `
                <div class="js-slide">
                  <div class="main-image-container">
                    <img
                      src="${img}"
                      class="img-fluid border-radius-3 w-100"
                      style="object-fit:cover;"
                      alt="Room Image"
                      onerror="this.onerror=null;this.src='/AppData/BaiViet/BaiVietMacDinh.jpg';"
                    />
                  </div>
                </div>`)
              .join('');

            // Hiển thị danh sách tiện nghi
            const amenitiesContainer = $('#roomModalAmenities');
            amenitiesContainer.empty();

            if (room.amenitiesList) {
                const amenityData = @Html.Raw(Json.Serialize(ViewBag.HotelAmenities));
                const amenitiesHtml = room.amenitiesList.split(',')
                .map(amenityId => {
                    const amenity = amenityData.find(a => a.id === parseInt(amenityId.trim()));
                    return amenity ? `
                    <div class="col-md-6 mb-0">
                        <div class="d-flex align-items-center card-color__icon">
                        <i class="${amenity.icon || 'fas fa-check-circle'} mr-3"></i>
                        <span>${amenity.name}</span>
                        </div>
                    </div>
                    ` : '';
                })
                .filter(html => html)
                .join('');

                amenitiesContainer.html(`<div class="row">${amenitiesHtml}</div>`);
            }

            // Thiết lập khởi tạo carousel sau khi modal hiển thị
            $modal.off('shown.bs.modal').on('shown.bs.modal', function() {
                try {
                    if ($.HSCore?.components?.HSSlickCarousel) {
                        $.HSCore.components.HSSlickCarousel.init('#roomModalCarousel');
                    } else {
                        $carousel.slick({
                            dots: true,
                            arrows: true,
                            infinite: true,
                            speed: 500,
                            slidesToShow: 1,
                            adaptiveHeight: false
                        });
                    }
                } catch(err) {
                    console.error('Carousel initialization error:', err);
                }
            });

            $modal.modal('show');

        } catch(err) {
            console.error('Error showing room modal:', err);
            alert('Có lỗi khi hiển thị thông tin phòng. Vui lòng thử lại sau.');
        }
    }

    // Khởi tạo các thành phần sau khi trang đã tải xong
    document.addEventListener('DOMContentLoaded', function() {
        setupRoomDetailsModal();
    });
</script>